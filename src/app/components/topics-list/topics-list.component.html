<div class="topics-container">
  <div class="topics-header">
    <h2 class="topics-title">Programs</h2>
    <div class="progress-section">
      <div class="progress-bar-container">
        <div class="progress-bar" [style.width.%]="getCompletionPercentage()"></div>
      </div>
      <span class="progress-text">{{ getCompletionPercentage() }}% Complete</span>
    </div>
  </div>

  <div class="topics-content">
    <div class="topics-list">
      <ng-container *ngFor="let topic of paginatedTopics">
        <div class="topic-item" [class.completed]="topic.completed">
          <div class="topic-main">
            <div class="topic-info">
              <button
                *ngIf="topic.subtopics.length > 0"
                class="expand-btn"
                (click)="toggleExpanded(topic.id)"
                [class.expanded]="topic.expanded">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <polyline points="9 18 15 12 9 6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>

              <div class="checkbox-wrapper">
                <input
                  type="checkbox"
                  [id]="'topic-' + topic.id"
                  [checked]="topic.completed"
                  (change)="toggleComplete(topic.id, true)"
                  class="topic-checkbox">
                <label [for]="'topic-' + topic.id" class="checkbox-label"></label>
              </div>

              <span class="topic-number">{{ topic.number }}.</span>
              <input
                type="text"
                [value]="topic.name"
                (blur)="updateTopicName(topic.id, $event)"
                class="topic-name-input"
                [class.completed-text]="topic.completed">
            </div>

            <button
              class="add-subtopic-btn"
              (click)="startAddingSubtopic(topic.id)"
              title="Add subtopic">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <line x1="12" y1="5" x2="12" y2="19" stroke-width="2" stroke-linecap="round"/>
                <line x1="5" y1="12" x2="19" y2="12" stroke-width="2" stroke-linecap="round"/>
              </svg>
              Add Subtopic
            </button>
          </div>

          <div class="subtopics-container" *ngIf="(topic.subtopics.length > 0 || isAddingSubtopicFor(topic.id)) && topic.expanded">
            <div *ngFor="let subtopic of topic.subtopics" class="subtopic-item" [class.completed]="subtopic.completed" [class.disabled]="topic.completed">
              <div class="subtopic-info">
                <div class="checkbox-wrapper">
                  <input
                    type="checkbox"
                    [id]="'subtopic-' + subtopic.id"
                    [checked]="subtopic.completed"
                    [disabled]="topic.completed"
                    (change)="toggleComplete(subtopic.id, false)"
                    class="topic-checkbox subtopic-checkbox">
                  <label [for]="'subtopic-' + subtopic.id" class="checkbox-label"></label>
                </div>

                <span class="topic-number" [class.text-disabled]="topic.completed">{{ subtopic.number }}.</span>

                <ng-container *ngIf="!isEditingSubtopic(subtopic.id)">
                  <span
                    class="subtopic-name-display"
                    [class.completed-text]="subtopic.completed"
                    [class.text-disabled]="topic.completed"
                    (dblclick)="!topic.completed && startEditingSubtopic(subtopic.id, subtopic.name)">
                    {{ subtopic.name }}
                  </span>
                  <div class="subtopic-action-btns">
                    <button
                      *ngIf="!topic.completed"
                      class="edit-subtopic-btn"
                      (click)="startEditingSubtopic(subtopic.id, subtopic.name)"
                      title="Edit subtopic">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                    <button
                      class="delete-subtopic-btn"
                      (click)="deleteSubtopic(topic.id, subtopic.id)"
                      [disabled]="true"
                      title="Delete subtopic (disabled - requires permission)">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </div>
                </ng-container>

                <ng-container *ngIf="isEditingSubtopic(subtopic.id)">
                  <input
                    type="text"
                    [(ngModel)]="editingSubtopics[subtopic.id]"
                    class="topic-name-input subtopic-name editing"
                    (keyup.enter)="saveSubtopicName(subtopic.id)"
                    (keyup.escape)="cancelEditingSubtopic(subtopic.id)">
                  <div class="subtopic-actions">
                    <button class="save-subtopic-btn" (click)="saveSubtopicName(subtopic.id)" title="Save">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <polyline points="20 6 9 17 4 12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                    <button class="cancel-subtopic-btn" (click)="cancelEditingSubtopic(subtopic.id)" title="Cancel">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <line x1="18" y1="6" x2="6" y2="18" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="6" y1="6" x2="18" y2="18" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </div>
                </ng-container>
              </div>
            </div>

            <!-- Add new subtopic form -->
            <div *ngIf="isAddingSubtopicFor(topic.id)" class="add-subtopic-form">
              <input
                type="text"
                [(ngModel)]="newSubtopicName"
                placeholder="Enter subtopic name..."
                class="new-subtopic-input"
                (keyup.enter)="saveNewSubtopic()"
                (keyup.escape)="cancelAddingSubtopic()">
              <div class="form-actions">
                <button class="save-btn" (click)="saveNewSubtopic()">Save</button>
                <button class="cancel-btn" (click)="cancelAddingSubtopic()">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <div class="add-topic-section" *ngIf="!isAddingTopic">
        <button class="add-topic-btn" (click)="startAddingTopic()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <line x1="12" y1="5" x2="12" y2="19" stroke-width="2" stroke-linecap="round"/>
            <line x1="5" y1="12" x2="19" y2="12" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Add New Topic
        </button>
      </div>

      <div class="add-topic-form" *ngIf="isAddingTopic">
        <input
          type="text"
          [(ngModel)]="newTopicName"
          placeholder="Enter topic name..."
          class="new-topic-input"
          (keyup.enter)="addNewTopic()"
          (keyup.escape)="cancelAddingTopic()">
        <div class="form-actions">
          <button class="save-btn" (click)="addNewTopic()">Save</button>
          <button class="cancel-btn" (click)="cancelAddingTopic()">Cancel</button>
        </div>
      </div>
    </div>

    <div class="pagination-wrapper">
      <div class="pagination" *ngIf="totalPages > 1">
        <button
          class="page-btn"
          [disabled]="currentPage === 1"
          (click)="previousPage()">
          Previous
        </button>

        <div class="page-numbers">
          <button
            *ngFor="let page of getPageNumbers()"
            class="page-number-btn"
            [class.active]="page === currentPage"
            (click)="goToPage(page)">
            {{ page }}
          </button>
        </div>

        <button
          class="page-btn"
          [disabled]="currentPage === totalPages"
          (click)="nextPage()">
          Next
        </button>
      </div>

      <div class="topics-counter">
        <span>{{ topics.length }} Topics</span>
      </div>
    </div>
  </div>
</div>
